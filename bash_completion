#!/bin/bash

_cower() {
  local COWER cur prev opts ng

  COWER=$(type -P cower)
  [[ -z $COWER ]] && return 0

  _get_comp_words_by_ref cur prev

  # nullglob avoids problems when no results are found
  [[ -o nullglob ]] || { shopt -s nullglob; ng=1; }

  opts="-d --download -i --info -m --msearch -s --search -u --update -c --color
        -f --force -q --quiet -t --target --threads -v --verbose --debug -h --help"

  if [[ $cur == -* ]]; then # options
    COMPREPLY=($(compgen -W "$opts" -- $cur))
  elif [[ $cur == --target= || $prev == '-t' ]]; then # directories
    COMPREPLY=($(compgen -f -- $cur))
  elif [[ ${COMP_WORDS[@]} = *-@(!(-*)[di]*|-download|-info)* ]]; then # aur packages
    COMPREPLY=($(compgen -W "$((( ${#cur} > 2 )) && $COWER -sq -- $cur 2>/dev/null)" -- $cur))
  elif [[ ${COMP_WORDS[@]} = *-@(!(-*)[u]*|--update)* ]]; then # local packages
    COMPREPLY=($(compgen -W "$(pacman -Qqm)" -- $cur))
  fi

  # restore nullglob setting
  [[ $ng ]] && shopt -u nullglob

}

complete -F _cower cower
